name: Issues Lark Notify

on:
  issues:
    types: [opened, edited, reopened, closed, deleted]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'
          
      - name: Install js-yaml
        run: npm install js-yaml
        
      - name: Read user mapping
        id: read_mapping
        run: |
          echo "mapping=$(cat .github/user_mapping.yml | base64 -w0)" >> $GITHUB_OUTPUT
          
      - name: Extract issue mentions
        id: extract_mentions
        uses: actions/github-script@v6
        with:
          script: |
            const issueBody = context.payload.issue.body || '';
            // æå–@ç”¨æˆ·åæ ¼å¼çš„æåŠ
            const mentionRegex = /@([a-zA-Z0-9_-]+)/g;
            const mentions = [];
            let match;
            while ((match = mentionRegex.exec(issueBody)) !== null) {
              mentions.push(match[1]);
            }
            
            // æ·»åŠ issueä½œè€…å’Œè§¦å‘è€…
            if(context.payload.issue.user && context.payload.issue.user.login) {
              mentions.push(context.payload.issue.user.login);
            }
            if(context.payload.sender && context.payload.sender.login) {
              mentions.push(context.payload.sender.login);
            }
            
            // å»é‡å¹¶è½¬æ¢ä¸ºå­—ç¬¦ä¸²ä¼ é€’
            const uniqueMentions = [...new Set(mentions)];
            return JSON.stringify(uniqueMentions);  // å°†æ•°ç»„è½¬ä¸ºJSONå­—ç¬¦ä¸²ä¼ é€’

      - name: Generate at elements
        id: generate_at
        uses: actions/github-script@v6
        with:
          script: |
            const yaml = require('js-yaml');
            const Buffer = require('buffer').Buffer;
            
            // è§£ç æ˜ å°„æ–‡ä»¶å†…å®¹
            const mappingBase64 = '${{ steps.read_mapping.outputs.mapping }}';
            const mappingContent = Buffer.from(mappingBase64, 'base64').toString('utf-8');
            const mapping = yaml.load(mappingContent);
            
            // è§£æä¸ºJSONå¯¹è±¡
            let mentions = [];
            try {
              // å°è¯•è§£æJSONå­—ç¬¦ä¸²
              mentions = JSON.parse('${{ steps.extract_mentions.outputs.result }}');
              // ç¡®ä¿mentionsæ˜¯ä¸€ä¸ªæ•°ç»„
              if (!Array.isArray(mentions)) {
                mentions = [mentions];
              }
            } catch (error) {
              console.error('è§£ææåŠåˆ—è¡¨æ—¶å‡ºé”™:', error);
              mentions = [];
            }
            
            const atElements = [];
            
            // ä¸ºæ¯ä¸ªæåŠçš„ç”¨æˆ·åˆ›å»º@æ ‡ç­¾
            for (let i = 0; i < mentions.length; i++) {
              const username = mentions[i];
              if (mapping.mapping && mapping.mapping[username]) {
                atElements.push({
                  tag: "at",
                  user_id: mapping.mapping[username],
                  user_name: username
                });
              }
            }
            
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ˜ å°„çš„ç”¨æˆ·ï¼Œåˆ™@æ‰€æœ‰äºº
            if (atElements.length === 0) {
              atElements.push({
                tag: "at",
                user_id: mapping.all || "all",
                user_name: "æ‰€æœ‰äºº"
              });
            }
            
            return JSON.stringify(atElements);  // è¿”å›JSONå­—ç¬¦ä¸²

      - name: Send Notification
        uses: northwang-lucky/chatbot-webhook-client@v1.1.1
        with:
          app: Lark
          webhook: ${{ secrets.LARK_WEBHOOK }}
          template: >-
            {
              "msg_type": "interactive",
              "card": {
                "schema": "2.0",
                "header": {
                  "title": {
                    "tag": "plain_text",
                    "content": "ğŸ”” Issue Update"
                  },
                  "template": "blue"
                },
                "body": {
                  "direction": "vertical",
                  "elements": [
                    {
                      "tag": "div",
                      "text": {
                        "tag": "lark_md",
                        "content": "**ä»“åº“ï¼š**"
                      }
                    },
                    {
                      "tag": "div",
                      "text": {
                        "tag": "lark_md",
                        "content": ${{ toJSON(github.event.repository.full_name) }}
                      }
                    },
                    {
                      "tag": "div",
                      "text": {
                        "tag": "lark_md",
                        "content": "**æ ‡é¢˜ï¼š**"
                      }
                    },
                    {
                      "tag": "div",
                      "text": {
                        "tag": "lark_md",
                        "content": ${{ toJSON(github.event.issue.title) }}
                      }
                    },
                    {
                      "tag": "div",
                      "text": {
                        "tag": "lark_md",
                        "content": "**çŠ¶æ€ï¼š**"
                      }
                    },
                    {
                      "tag": "div",
                      "text": {
                        "tag": "lark_md",
                        "content": ${{ toJSON(github.event.issue.state) }}
                      }
                    },
                    {
                      "tag": "div",
                      "text": {
                        "tag": "lark_md",
                        "content": "**æ“ä½œï¼š**"
                      }
                    },
                    {
                      "tag": "div",
                      "text": {
                        "tag": "lark_md",
                        "content": ${{ toJSON(github.event.action) }}
                      }
                    },
                    {
                      "tag": "div",
                      "text": {
                        "tag": "lark_md",
                        "content": "**ç”¨æˆ·ï¼š**"
                      }
                    },
                    {
                      "tag": "div",
                      "text": {
                        "tag": "lark_md",
                        "content": ${{ toJSON(github.event.issue.user.login) }}
                      }
                    },
                    {
                      "tag": "div",
                      "text": {
                        "tag": "lark_md",
                        "content": "**è§¦å‘è€…ï¼š**"
                      }
                    },
                    {
                      "tag": "div",
                      "text": {
                        "tag": "lark_md",
                        "content": ${{ toJSON(github.actor) }}
                      }
                    },
                    {
                      "tag": "div",
                      "text": {
                        "tag": "lark_md",
                        "content": "**æ—¶é—´ï¼š**"
                      }
                    },
                    {
                      "tag": "div",
                      "text": {
                        "tag": "lark_md",
                        "content": ${{ toJSON(github.event.issue.updated_at) }}
                      }
                    },
                    {
                      "tag": "div",
                      "text": {
                        "tag": "lark_md",
                        "content": "**å†…å®¹ï¼š**"
                      }
                    },
                    {
                      "tag": "div",
                      "text": {
                        "tag": "lark_md",
                        "content": ${{ toJSON(github.event.issue.body) }}
                      }
                    },
                    {
                      "tag": "div",
                      "text": {
                        "tag": "lark_md",
                        "content": "**ç›¸å…³äººå‘˜ï¼š**"
                      }
                    },
                    ${{ steps.generate_at.outputs.result }},
                    {
                      "tag": "button",
                      "text": {
                        "tag": "plain_text",
                        "content": "ğŸ‘‰ æŸ¥çœ‹è¯¦æƒ…"
                      },
                      "type": "primary",
                      "behaviors": [
                        {
                          "type": "open_url",
                          "default_url": "${{ github.event.issue.html_url }}"
                        }
                      ]
                    }
                  ]
                }
              }
            }
          github-token: ${{ secrets.GITHUB_TOKEN }}
