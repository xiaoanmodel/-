name: PR Lark Notify

on:
    pull_request:
        types:
            - opened
            - edited
            - reopened
            - closed
            - synchronize

jobs:
    notify:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v3
            
            - name: Read user mapping
              id: read_mapping
              run: |
                echo "::set-output name=mapping::$(cat .github/user_mapping.yml | base64 -w0)"
                
            - name: Extract PR mentions
              id: extract_mentions
              uses: actions/github-script@v6
              with:
                script: |
                  const prBody = context.payload.pull_request.body || '';
                  // ÊèêÂèñ@Áî®Êà∑ÂêçÊ†ºÂºèÁöÑÊèêÂèä
                  const mentionRegex = /@([a-zA-Z0-9_-]+)/g;
                  const mentions = [];
                  let match;
                  while ((match = mentionRegex.exec(prBody)) !== null) {
                    mentions.push(match[1]);
                  }
                  
                  // Ê∑ªÂä†PR‰ΩúËÄÖ„ÄÅËß¶ÂèëËÄÖÂíåÂÆ°Ê†∏‰∫∫Âëò
                  if(context.payload.pull_request.user && context.payload.pull_request.user.login) {
                    mentions.push(context.payload.pull_request.user.login);
                  }
                  if(context.payload.sender && context.payload.sender.login) {
                    mentions.push(context.payload.sender.login);
                  }
                  
                  // Ê∑ªÂä†ÂÆ°ÈòÖËÄÖ
                  const reviewers = context.payload.pull_request.requested_reviewers || [];
                  reviewers.forEach(reviewer => {
                    if(reviewer.login) {
                      mentions.push(reviewer.login);
                    }
                  });
                  
                  // ÂéªÈáç
                  const uniqueMentions = [...new Set(mentions)];
                  return JSON.stringify(uniqueMentions);

            - name: Generate at elements
              id: generate_at
              uses: actions/github-script@v6
              with:
                script: |
                  const fs = require('fs');
                  const yaml = require('js-yaml');
                  const Buffer = require('buffer').Buffer;
                  
                  // Ëß£Á†ÅÊò†Â∞ÑÊñá‰ª∂ÂÜÖÂÆπ
                  const mappingBase64 = '${{ steps.read_mapping.outputs.mapping }}';
                  const mappingContent = Buffer.from(mappingBase64, 'base64').toString('utf-8');
                  const mapping = yaml.load(mappingContent);
                  
                  const mentions = JSON.parse('${{ steps.extract_mentions.outputs.result }}');
                  const atElements = [];
                  
                  // ‰∏∫ÊØè‰∏™ÊèêÂèäÁöÑÁî®Êà∑ÂàõÂª∫@Ê†áÁ≠æ
                  mentions.forEach(username => {
                    if (mapping.mapping && mapping.mapping[username]) {
                      atElements.push({
                        tag: "at",
                        user_id: mapping.mapping[username],
                        user_name: username
                      });
                    }
                  });
                  
                  // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞Êò†Â∞ÑÁöÑÁî®Êà∑ÔºåÂàô@ÊâÄÊúâ‰∫∫
                  if (atElements.length === 0) {
                    atElements.push({
                      tag: "at",
                      user_id: mapping.all || "all",
                      user_name: "ÊâÄÊúâ‰∫∫"
                    });
                  }
                  
                  return JSON.stringify(atElements);

            - name: Send Notification
              uses: northwang-lucky/chatbot-webhook-client@v1.1.1
              with:
                  app: Lark
                  webhook: ${{ secrets.LARK_WEBHOOK }}
                  template: >-
                        {
                            "msg_type": "interactive",
                            "card": {
                                "schema": "2.0",
                                "header": {
                                    "title": {
                                        "tag": "plain_text",
                                        "content": "üîÑ Pull Request Update"
                                    },
                                    "template": "green"
                                },
                                "body": {
                                    "direction": "vertical",
                                    "elements": [
                                        {
                                            "tag": "div",
                                            "text": {
                                                "tag": "lark_md",
                                                "content": "**‰ªìÂ∫ìÔºö**"
                                            }
                                        },
                                        {
                                            "tag": "div",
                                            "text": {
                                                "tag": "lark_md",
                                                "content": ${{ toJSON(github.event.repository.full_name) }}
                                            }
                                        },
                                        {
                                            "tag": "div",
                                            "text": {
                                                "tag": "lark_md",
                                                "content": "**Ê†áÈ¢òÔºö**"
                                            }
                                        },
                                        {
                                            "tag": "div",
                                            "text": {
                                                "tag": "lark_md",
                                                "content": ${{ toJSON(github.event.pull_request.title) }}
                                            }
                                        },
                                        {
                                            "tag": "div",
                                            "text": {
                                                "tag": "lark_md",
                                                "content": "**Áä∂ÊÄÅÔºö**"
                                            }
                                        },
                                        {
                                            "tag": "div",
                                            "text": {
                                                "tag": "lark_md",
                                                "content": ${{ toJSON(github.event.pull_request.state) }}
                                            }
                                        },
                                        {
                                            "tag": "div",
                                            "text": {
                                                "tag": "lark_md",
                                                "content": "**Êìç‰ΩúÔºö**"
                                            }
                                        },
                                        {
                                            "tag": "div",
                                            "text": {
                                                "tag": "lark_md",
                                                "content": ${{ toJSON(github.event.action) }}
                                            }
                                        },
                                        {
                                            "tag": "div",
                                            "text": {
                                                "tag": "lark_md",
                                                "content": "**‰ΩúËÄÖÔºö**"
                                            }
                                        },
                                        {
                                            "tag": "div",
                                            "text": {
                                                "tag": "lark_md",
                                                "content": ${{ toJSON(github.event.pull_request.user.login) }}
                                            }
                                        },
                                        {
                                            "tag": "div",
                                            "text": {
                                                "tag": "lark_md",
                                                "content": "**Ëß¶ÂèëËÄÖÔºö**"
                                            }
                                        },
                                        {
                                            "tag": "div",
                                            "text": {
                                                "tag": "lark_md",
                                                "content": ${{ toJSON(github.actor) }}
                                            }
                                        },
                                        {
                                            "tag": "div",
                                            "text": {
                                                "tag": "lark_md",
                                                "content": "**Êó∂Èó¥Ôºö**"
                                            }
                                        },
                                        {
                                            "tag": "div",
                                            "text": {
                                                "tag": "lark_md",
                                                "content": ${{ toJSON(github.event.pull_request.updated_at) }}
                                            }
                                        },
                                        {
                                            "tag": "div",
                                            "text": {
                                                "tag": "lark_md",
                                                "content": "**ÂÜÖÂÆπÔºö**"
                                            }
                                        },
                                        {
                                            "tag": "div",
                                            "text": {
                                                "tag": "lark_md",
                                                "content": ${{ toJSON(github.event.pull_request.body) }}
                                            }
                                        },
                                        {
                                            "tag": "div",
                                            "text": {
                                                "tag": "lark_md",
                                                "content": "**‰ªéÔºö** ${{github.event.pull_request.head.ref}} **ÂàÜÊîØ** Âà∞ ${{github.event.pull_request.base.ref}} **ÂàÜÊîØ** "
                                            }
                                        },
                                        {
                                            "tag": "div",
                                            "text": {
                                                "tag": "lark_md",
                                                "content": "**Áõ∏ÂÖ≥‰∫∫ÂëòÔºö**"
                                            }
                                        },
                                        ${{ steps.generate_at.outputs.result }},
                                        {
                                            "tag": "button",
                                            "text": {
                                                "tag": "plain_text",
                                                "content": "üëâ Êü•ÁúãËØ¶ÊÉÖ"
                                            },
                                            "type": "primary",
                                            "behaviors": [
                                                {
                                                    "type": "open_url",
                                                    "default_url": ${{ toJSON(github.event.pull_request.html_url) }}
                                                }
                                            ]   
                                        }
                                    ]
                                }
                            }
                        }
                  github-token: ${{ secrets.GITHUB_TOKEN }}
